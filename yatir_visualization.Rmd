---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.4
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
import os
import numpy as np
import xarray as xr
import pandas as pd
import seaborn as sns
import holoviews as hv
from holoviews import opts
import geoviews as gv
import geoviews.feature as gf
import matplotlib.pyplot as plt

import geoviews_tools as gt
from timutils.git_tools import print_cwd_git_version
```

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
print('git: ', end='')
print_cwd_git_version()
gv.extension('bokeh')
```

# Yatir Parameterizaton WRF results

A collection of plots showing WRF-simulated surface energy and carbon fluxes for two different simulations of Yatir Forest in Israel.  The first WRF run is a control run using 'out of the box' NOAH-MP land surface parameterizations derived from MODIS land cover types.  The second WRF run is an experimental run that set a 15-km radius surrounding Yatir Forest to a lower albedo and higher surface roughness length relative to both the open shrubland PFT that occupies the area in the control run as well as the desert surrounding the forest.

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
cscratch_path = os.path.join('/', 'global', 'cscratch1', 'sd', 'twhilton')
cscratch_path = '/Users/tim/work/Data/SummenWRF/yatir/'
fluxes_ytr = gt.yatir_WRF_to_xarray(os.path.join(cscratch_path, 'fluxes_yatir_run_d03.nc'))
fluxes_ctl = gt.yatir_WRF_to_xarray(os.path.join(cscratch_path, 'fluxes_ctl_run_d03.nc'))
ctlday = gt.WRF_daily_daylight_avg(os.path.join(cscratch_path, 'ctl_run_d03_diag.nc'))
ytrday = gt.WRF_daily_daylight_avg(os.path.join(cscratch_path, 'yatir_run_d03_diag.nc'))
```

```{python}
#define some holoviews dimensions
dims = gt.define_dims(fluxes_ctl)
cmaps = {'GPP': 'Greens',
        'LH': 'Blues',
        'HFX': 'Reds',
        'FVEG': 'Greens',
        'SWDOWN': 'YlOrRd',
        'FSA': 'YlOrRd',
        'FIRA': 'YlOrRd'}
```

```{python}
ds_diff = xr.concat([ctlday, ytrday, ctlday - ytrday], dim=pd.Index(['control', 'yatir', 'difference'], name='WRFrun'))
```

```{python}
dim_WRFrun = hv.Dimension('WRFrun', label='WRF run')
ds = {(WRFrun, var): gv.Dataset(ds_diff.sel(WRFrun=WRFrun), 
                                kdims=[dims['hour'], dims['lon'], dims['lat']], 
                                vdims=[dims[var]])
       for WRFrun in list(ds_diff.WRFrun.values)
       for var in ctlday.data_vars}
```

```{python}
def make_var_layout(ds, varname, ncols=2):
    """make HoloViews layout showing Yatir, Control, and difference
    """
    #TODO: adjust the colorscale limits for the difference plot
    #TODO: use a diverging colormap for the difference plots
    var_layout = hv.Layout([ds[WRFrun, varname].to(gv.QuadMesh, 
                            kdims=[dims['lon'], dims['lat']], 
                            vdims=varname).opts(colorbar=True, 
                                                padding=0.1,
                                                cmap=cmaps[varname],
                                                title=WRFrun)
                             for WRFrun in ['control', 'yatir', 'difference']]).cols(
        ncols).opts(title=dims[varname].label)
    layout_with_map = var_layout * gf.borders(scale='50m') * gf.coastline(scale='50m') * gf.ocean(scale='50m')
    return(layout_with_map)
```

Show vegetation fraction output by WRF for the control run and Yatir parameterization run.  *Finally* WRF is setting the vegetation fraction for Yatir Forest to 0.40.  I chose 0.40 to match the (approximate) most densly vegetated pixels in this region in the MODIS data ('control' panel below).

```{python}
this_layout = hv.Layout([gv.Dataset(ds.sel(hour=10), # hour is arbitrary for vegetation fraction
                      kdims=[dims['lon'], dims['lat']]).to(gv.QuadMesh, 
                                          kdims=[dims['lon'], dims['lat']], 
                                          vdims=dims['FVEG']).opts(cmap=cmaps['FVEG'], 
                                                                   colorbar=True,
                                                                   title=label)
           for label, ds in dict(zip(['control', 'Yatir'], [ctlday, ytrday])).items()]).opts(
    title=dims['FVEG'].label)
this_layout * gf.borders(scale='50m') * gf.coastline(scale='50m') * gf.ocean(scale='50m')
```

The plots show surface energy and carbon fluxes simulated by WRF for the control run, the Yatir parameterization run, and the difference between the two runs for daylight hours.  The runs should constrast more after the vegetation fraction problem is fixed.

```{python}
make_var_layout(ds, 'SWDOWN')
```

```{python}
make_var_layout(ds, 'FSA')
```

```{python}
make_var_layout(ds, 'FIRA')
```

```{python}
make_var_layout(ds, 'HFX')
```

```{python}
make_var_layout(ds, 'LH')
```

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
# Yatir parameterization #
<!-- #endregion -->

```{python}
from yatir_land_parameters import format_landparm, format_vegparm
vegparm_str = format_vegparm()
landparm_str = format_landparm()
# print these two strings and paste them into a markdown cell to get a nicely formatted version
```

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
#### VEGPARM.TBL ####
|    |   ALBD |      SLMO |      SFEM |      SFZ0 |    THERIN |      SCFX |      SFHC |  LANDCOVER                           |
|---:|-------:|----------:|----------:|----------:|----------:|----------:|----------:|:-------------------------------------|
|  1 |     12 |      0.3  |     0.95  |     50    |       4   |      3.33 |  2.92e+06 | 'Evergreen Needleleaf Forest'        |
|  2 |     12 |      0.5  |     0.95  |     50    |       5   |      1.67 |  2.92e+06 | 'Evergreen Broadleaf Forest'         |
|  3 |     14 |      0.3  |     0.94  |     50    |       4   |      2.86 |  2.5e+06  | 'Deciduous Needleleaf Forest'        |
|  4 |     16 |      0.3  |     0.93  |     50    |       4   |      2.63 |  2.5e+06  | 'Deciduous Broadleaf Forest'         |
|  5 |     13 |      0.3  |     0.97  |     50    |       4   |      2.11 |  4.18e+06 | 'Mixed Forests'                      |
|  6 |     22 |      0.1  |     0.93  |      5    |       3   |      1.56 |  2.08e+06 | 'Closed Shrublands'                  |
|  7 |     20 |      0.15 |     0.95  |      6    |       3   |      2.14 |  2.08e+06 | 'Open Shrublands'                    |
|  8 |     22 |      0.1  |     0.93  |      5    |       3   |      1.56 |  2.08e+06 | 'Woody Savannas'                     |
|  9 |     20 |      0.15 |     0.92  |     15    |       3   |      2    |  2.5e+06  | 'Savannas'                           |
| 10 |     19 |      0.15 |     0.96  |     12    |       3   |      2.37 |  2.08e+06 | 'Grasslands'                         |
| 11 |     14 |      0.42 |     0.95  |     30    |       5.5 |      1.32 |  3.55e+06 | 'Permanent wetlands'                 |
| 12 |     17 |      0.3  |     0.985 |     15    |       4   |      2.71 |  2.5e+06  | 'Croplands'                          |
| 13 |     15 |      0.1  |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Urban and Built-Up'                 |
| 14 |     18 |      0.25 |     0.98  |     14    |       4   |      2.56 |  2.5e+06  | 'cropland/natural vegetation mosaic' |
| 15 |     55 |      0.95 |     0.95  |      0.1  |       5   |      0    |  9e+25    | 'Snow and Ice'                       |
| 16 |     25 |      0.02 |     0.9   |      1    |       2   |      0.81 |  1.2e+06  | 'Barren or Sparsely Vegetated'       |
| 17 |      8 |      1    |     0.98  |      0.01 |       6   |      0    |  9e+25    | 'Water'                              |
| 18 |     15 |      0.5  |     0.93  |     30    |       5   |      2.67 |  9e+25    | 'Wooded Tundra'                      |
| 19 |     15 |      0.5  |     0.92  |     15    |       5   |      2.67 |  9e+25    | 'Mixed Tundra'                       |
| 20 |     12 |      0.02 |     0.97  |     50    |       3   |      1.67 |  1.89e+06 | 'Yatir'                              |
| 21 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 22 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 23 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 24 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 25 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 26 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 27 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 28 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 29 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 30 |     15 |      0.02 |     0.88  |     80    |       3   |      1.67 |  1.89e+06 | 'Unassigned'                         |
| 31 |     10 |      0.1  |     0.97  |     80    |       3   |      1.67 |  1.89e+06 | 'Low Intensity Residential '         |
| 32 |     10 |      0.1  |     0.97  |     80    |       3   |      1.67 |  1.89e+06 | 'High Intensity Residential'         |
| 33 |     10 |      0.1  |     0.97  |     80    |       3   |      1.67 |  1.89e+06 | 'Industrial or Commercial'           |
<!-- #endregion -->

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
#### LANDPARM.TBL ####
|    |   SHDFAC |    NROOT |      RS |         RGL |         HS |         SNUP |     MAXALB |      LAIMIN |     LAIMAX |      EMISSMIN |    EMISSMAX |    ALBEDOMIN |    ALBEDOMAX |      Z0MIN |      Z0MAX |      ZTOPV |       ZBOTV |  LANDCOVER'                          |
|---:|---------:|---------:|--------:|------------:|-----------:|-------------:|-----------:|------------:|-----------:|--------------:|------------:|-------------:|-------------:|-----------:|-----------:|-----------:|------------:|:-------------------------------------|
|  1 |     0.7  |        4 |     125 |          30 |      47.35 |        0.08  |         52 |        5    |       6.4  |          0.95 |       0.95  |         0.12 |         0.12 |     0.5    |     0.5    |      17    |        8.5  | 'Evergreen Needleleaf Forest'        |
|  2 |     0.95 |        4 |     150 |          30 |      41.69 |        0.08  |         35 |        3.08 |       6.48 |          0.95 |       0.95  |         0.12 |         0.12 |     0.5    |     0.5    |      35    |        1    | 'Evergreen Broadleaf Forest'         |
|  3 |     0.7  |        4 |     150 |          30 |      47.35 |        0.08  |         54 |        1    |       5.16 |          0.93 |       0.94  |         0.14 |         0.15 |     0.5    |     0.5    |      14    |        7    | 'Deciduous Needleleaf Forest'        |
|  4 |     0.8  |        4 |     100 |          30 |      54.53 |        0.08  |         58 |        1.85 |       3.31 |          0.93 |       0.93  |         0.16 |         0.17 |     0.5    |     0.5    |      20    |       11.5  | 'Deciduous Broadleaf Forest'         |
|  5 |     0.8  |        4 |     125 |          30 |      51.93 |        0.08  |         53 |        2.8  |       5.5  |          0.93 |       0.97  |         0.17 |         0.25 |     0.2    |     0.5    |      18    |       10    | 'Mixed Forests'                      |
|  6 |     0.7  |        3 |     300 |         100 |      42    |        0.03  |         60 |        0.5  |       3.66 |          0.93 |       0.93  |         0.25 |         0.3  |     0.01   |     0.05   |       0.5  |        0.1  | 'Closed Shrublands'                  |
|  7 |     0.7  |        3 |     170 |         100 |      39.18 |        0.035 |         65 |        0.6  |       2.6  |          0.93 |       0.95  |         0.22 |         0.3  |     0.01   |     0.06   |       0.5  |        0.1  | 'Open Shrublands'                    |
|  8 |     0.7  |        3 |     300 |         100 |      42    |        0.03  |         60 |        0.5  |       3.66 |          0.93 |       0.93  |         0.25 |         0.3  |     0.01   |     0.05   |       0.5  |        0.1  | 'Woody Savannas'                     |
|  9 |     0.5  |        3 |      70 |          65 |      54.53 |        0.04  |         50 |        0.5  |       3.66 |          0.92 |       0.92  |         0.2  |         0.2  |     0.15   |     0.15   |       0.5  |        0.1  | 'Savannas'                           |
| 10 |     0.8  |        3 |      40 |         100 |      36.35 |        0.04  |         70 |        0.52 |       2.9  |          0.92 |       0.96  |         0.19 |         0.23 |     0.1    |     0.12   |       0.5  |        0.01 | 'Grasslands'                         |
| 11 |     0.6  |        2 |      70 |          65 |      55.97 |        0.015 |         59 |        1.75 |       5.72 |          0.95 |       0.95  |         0.14 |         0.14 |     0.3    |     0.3    |       0    |        0    | 'Permanent wetlands'                 |
| 12 |     0.8  |        3 |      40 |         100 |      36.25 |        0.04  |         66 |        1.56 |       5.68 |          0.92 |       0.985 |         0.17 |         0.23 |     0.05   |     0.15   |       0.5  |        0.01 | 'Croplands'                          |
| 13 |     0.1  |        1 |     200 |         999 |     999    |        0.04  |         46 |        1    |       1    |          0.88 |       0.88  |         0.15 |         0.15 |     0.5    |     0.5    |       0    |        0    | 'Urban and Built-Up'                 |
| 14 |     0.8  |        3 |      40 |         100 |      36.25 |        0.04  |         68 |        2.29 |       4.29 |          0.92 |       0.98  |         0.18 |         0.23 |     0.05   |     0.14   |       0.5  |        0.01 | 'cropland/natural vegetation mosaic' |
| 15 |     0    |        1 |     999 |         999 |     999    |        0.02  |         82 |        0.01 |       0.01 |          0.95 |       0.95  |         0.55 |         0.7  |     0.001  |     0.001  |       0    |        0    | 'Snow and Ice'                       |
| 16 |     0.01 |        1 |     999 |         999 |     999    |        0.02  |         75 |        0.1  |       0.75 |          0.9  |       0.9   |         0.38 |         0.38 |     0.01   |     0.01   |       0.02 |        0.01 | 'Barren or Sparsely Vegetated'       |
| 17 |     0    |        0 |     100 |          30 |      51.75 |        0.01  |         70 |        0.01 |       0.01 |          0.98 |       0.98  |         0.08 |         0.08 |     0.0001 |     0.0001 |       0    |        0    | 'Water'                              |
| 18 |     0.6  |        3 |     150 |         100 |      42    |        0.025 |         55 |        0.41 |       3.35 |          0.93 |       0.93  |         0.15 |         0.2  |     0.3    |     0.3    |      10    |        0.1  | 'Wooded Tundra'                      |
| 19 |     0.6  |        3 |     150 |         100 |      42    |        0.025 |         60 |        0.41 |       3.35 |          0.92 |       0.92  |         0.15 |         0.2  |     0.15   |     0.15   |       5    |        0.1  | 'Mixed Tundra'                       |
| 20 |     0.56 |        4 |     286 |          30 |      47.35 |        0.08  |         52 |        3    |       3    |          0.97 |       0.97  |         0.12 |         0.12 |     2      |     2      |      10    |        1    | 'Yatir'                              |
<!-- #endregion -->

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
# Sensible Heat #
<!-- #endregion -->

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
Yatir sensible heat flux in late August 2015 was 368.8 to 434.4 W m$^{-2}$ ([Brugger et al 2018](https://doi.org/10.1007/s10546-018-0371-5). Table 3).  There was a strong diurnal cycle for both sites (forest and desert).  Note the figure units are K m s$^{-1}$.  Figure from [Banerjee et al, 2018]([www.atmos-chem-phys.net/18/10025/2018/).
            <img src="./Banergee_etal_ACP_2018_fig3.pdf" width=900/>
<!-- #endregion -->

```{python}
t_dim = hv.Dimension('time', label='date', unit='y/m/d')
hfx_dim = hv.Dimension('HFX', label='sensible heat flux', unit='W m-2')
area_dim = hv.Dimension('area', label='parameterization', values=['Yatir cells', 'Desert cells'])
WRFrun_dim = hv.Dimension('WRFrun', label='WRF run', values=['Yatir WRF run', 'Control WRF run'])
```

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
dscombined = xr.concat((HFXytr_d03, HFXctl_d03), dim=pd.Index(['Yatir WRF run', 'Control WRF run'], name='WRFrun'))
hvds = hv.Dataset(dscombined, kdims=['time', 'x', 'y', 'WRFrun'], vdims=['HFX', 'lat', 'lon'])
```

```{python}
hfx_yatir = dscombined.where(dscombined.yatir_mask).mean(dim=['x', 'y'])
hfx_desert = dscombined.where(np.logical_not(dscombined.yatir_mask)).mean(dim=['x', 'y'])
hfx = xr.concat((hfx_yatir, hfx_desert), dim=pd.Index(['Yatir cells', 'Desert cells'], name='area'))
hfxds = hv.Dataset(hfx, [WRFrun_dim, area_dim, t_dim], hfx_dim)
#hfxds.to(hv.Curve, [t_dim], [hfx_dim]).opts(width=600).overlay('area')
```

```{python}
from holoviews.plotting.links import RangeToolLink
hfx_curve = hfxds.to(hv.Curve, [t_dim], [hfx_dim]).overlay('area')
hfx_all = hfx_curve.relabel('HFX').opts(width=600, labelled=['y'], toolbar='above')
hfx_zoomed = hfx_curve.opts(width=600, height=200, default_tools=[], toolbar='disable')
RangeToolLink(source=hfx_all.data[('Yatir WRF run',)][('Yatir cells',)], 
              target=hfx_zoomed.data[('Yatir WRF run',)][('Yatir cells',)], 
              axes=['x', 'y'])
layout = (hfx_all + hfx_zoomed).cols(1)
layout.opts(opts.Layout(shared_axes=False, merge_tools=False))
```

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
# %matplotlib inline
HFX_masked = dscombined.where(dscombined.yatir_mask)
gv.Dataset(HFX_masked, kdims=['WRFrun', 'time', 'lon', 'lat']).to(hv.QuadMesh, ['lon', 'lat'])[:, ::10, :, :]
```

Parse Yatir Forest eddy covariance data

```{python}
df_ytr = pd.read_csv('/Users/tim/work/Data/Yatir_Forest_Data/EFDC_L2_Flx_ILYat_2015_v03_30m.txt',
                    na_values=[-9999])
df_ytr['time'] = pd.to_datetime(df_ytr['TIMESTAMP_START'], format='%Y%m%d%H%M')
df_ytr.replace()
hv_ytr = hv.Table(df_ytr)
cv_obs = hv_ytr.to.curve('time', 'H', [], label='observed')
cv_obs.opts(width=600)
```

Plot HFX for both WRF runs (Control, Yatir) overlaid on a single axes.

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
hv.extension('bokeh')
hfx_dim_zoomed = hv.Dimension('HFX_zoomed', label='sensible heat flux', unit='W m-2')
def two_panel_energy_flux_plot(ds, obs, t_str=""):
    """make a plot of Yatir surface energy fluxes"""
    gvds = gv.Dataset(ds, kdims=['WRFrun',  'time', 'x', 'y'])
    WRF_run_labels = ds['WRFrun'].values
    line_styles = ['solid', 'dashed']
    cv = [hv.Curve(gvds.reduce(['x', 'y'], 
                               function=np.nanmean).select(WRFrun=this_run), 
                   t_dim, this_v_dim,
                   label=this_run).opts(opts.Curve(line_dash=this_linestyle, line_width=1))
          for this_run, this_linestyle, this_v_dim in zip(WRF_run_labels, 
                                                          line_styles, 
                                                         [hfx_dim, hfx_dim_zoomed])]
    overlay_opts=opts.Overlay(frame_width=690, 
                              legend_position='right', 
                              ylim=(0, 450),
                             title_format=t_str)
    cv_hfx = hv.Overlay(cv).opts(overlay_opts)
    overlay_opts=opts.Overlay(frame_width=690, legend_position='right', ylim=(350, 450))
    cv_hfx_zoomed = hv.Overlay(cv).opts(overlay_opts)
    hvly = hv.Layout([cv_hfx, cv_hfx_zoomed]).cols(1).opts(norm={'axiswise': True})
    return(hvly, cv_hfx, cv_hfx_zoomed)
```

```{python}
all_d03_cells_time_series, cv_hfx, cv_hfx_zoomed = two_panel_energy_flux_plot(dscombined, cv_obs, "all WRF d03 cells")
```

[Brugger et al (2018)](https://doi.org/10.1007/s10546-018-0371-5).  Question from Michael - why are the units W m$^{-1}$ and not W m$^{-2}$?
<img src="./Brugger_etal_2018_table3.jpg" width=900/>
