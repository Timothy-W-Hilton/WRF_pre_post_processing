---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.4
  kernelspec:
    display_name: wrfhv
    language: python
    name: wrfhv
---

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
import os
import numpy as np
import xarray as xr
import pandas as pd
import seaborn as sns
import holoviews as hv
from holoviews import opts
import geoviews as gv
import geoviews.feature as gf
import matplotlib.pyplot as plt
import cartopy.crs as ccrs

import geoviews_tools as gt
from timutils.git_tools import print_cwd_git_version
```

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
print('git: ', end='')
print_cwd_git_version()
gv.extension('matplotlib')
```

# Yatir Parameterizaton WRF results

A collection of plots showing WRF-simulated surface energy and carbon fluxes for two different simulations of Yatir Forest in Israel.  The first WRF run is a control run using 'out of the box' NOAH-MP land surface parameterizations derived from MODIS land cover types.  The second WRF run is an experimental run that set a 15-km radius surrounding Yatir Forest to a lower albedo and higher surface roughness length relative to both the open shrubland PFT that occupies the area in the control run as well as the desert surrounding the forest.

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
ctlday, ytrday, ctl_minus_ytr = gt.merge_yatir_fluxes_landuse()
```

```{python}
#define some holoviews dimensions
dims = gt.define_dims(ctlday)
# provide a default value for time dimension; this determines initial slider position
dims['hour'] = hv.Dimension('hour', label='hour of day', unit='UTC', default=9)
```

```{python}
ds_diff = xr.concat([ctlday, ytrday, ctl_minus_ytr], 
                    dim=pd.Index(['control', 'yatir', 'difference'], name='WRFrun'))
```

```{python}
dim_WRFrun = hv.Dimension('WRFrun', label='WRF run')
ds = {(WRFrun, var): gv.Dataset(ds_diff.sel(WRFrun=WRFrun)[var], 
                                kdims=[dims['hour'], dims['lon'], dims['lat']], 
                                vdims=[dims[var]])
       for WRFrun in list(ds_diff.WRFrun.values)
       for var in ['SWDOWN', 'HFX', 'LH', 'GPP', 'FVEG', 'FSA', 'FIRA']}
# need to skip the two landuse variables in creating the dict because they do not have an 'hours' dimension
```

```{python}
def get_cmaps():
    """define colormaps by WRFrun and variable
    
    WRF runs: ['control', 'yatir, 'difference']
    variables: ['GPP', 'LH', 'HFX', 'FVEG', 'SWDOWN', 'FSA', 'FIRA']
    
    sets a sequential colormap for each variable 
    for yatir and control runs and a diverging
    colormap for the differences
    """
    var_cmaps = {'GPP': 'Greens',
                'LH': 'Blues',
                'HFX': 'Reds',
                'FVEG': 'Greens',
                'SWDOWN': 'YlOrRd',
                'FSA': 'YlOrRd',
                'FIRA': 'YlOrRd'}
    cmaps = {}
    for k, v in var_cmaps.items():
        for run in ['control', 'yatir', 'difference']:
            if run in ['control', 'yatir']:
                cmaps[(k, run)] = var_cmaps[k]
            else:
                cmaps[(k, run)] = 'BrBG'
    return(cmaps)       
```

```{python}
def make_var_layout(ds, varname, ncols=2):
    """make HoloViews layout showing Yatir, Control, and difference
    """
    this_min = {k: v.data.to_array().values.min() for k, v in ds.items()}
    this_max = {k: v.data.to_array().values.max() for k, v in ds.items()}
    this_absmax = {k: np.abs(v.data.to_array().values).max() for k, v in ds.items()}
    clims = {'control': (min(this_min['control', varname],
                             this_min['yatir', varname]),
                         max(this_max['control', varname],
                             this_max['yatir', varname])),
             'difference': (this_absmax['difference', varname] * -1.0,
                            this_absmax['difference', varname])}
    clims['yatir'] = clims['control']
             
    cbar_sym = {'control': False,
                'yatir': False,
                'difference': True}
    #TODO: adjust the colorscale limits for the difference plot
    #TODO: use a diverging colormap for the difference plots
    var_layout = hv.Layout([ds[WRFrun, varname].to(gv.QuadMesh, 
                            kdims=[dims['lon'], dims['lat']], 
                            vdims=varname,
                            dynamic=True).opts(colorbar=True, 
                                                padding=0.1,
                                                clim=clims[WRFrun],
                                                cmap=get_cmaps()[varname, WRFrun],
                                                title=WRFrun,
                                                projection=ccrs.PlateCarree())
                             for WRFrun in ['control', 'yatir', 'difference']]).cols(
        ncols).opts(title=dims[varname].label)
    layout_with_map = var_layout * gf.borders(scale='50m') * gf.coastline(scale='50m')# * gf.ocean(scale='50m')
    return(layout_with_map)
```

Show vegetation fraction output by WRF for the control run and Yatir parameterization run.  *Finally* WRF is setting the vegetation fraction for Yatir Forest to 0.40.  I chose 0.40 to match the (approximate) most densly vegetated pixels in this region in the MODIS data ('control' panel below).

```{python}
this_layout = hv.Layout([gv.Dataset(ds.sel(hour=10), # hour is arbitrary for vegetation fraction
                      kdims=[dims['lon'], dims['lat']]).to(gv.QuadMesh, 
                                          kdims=[dims['lon'], dims['lat']], 
                                          vdims=dims['FVEG']).opts(cmap=get_cmaps()['FVEG', 
                                                                                    'control'], 
                                                                   colorbar=True,
                                                                   title=label,
                                                                   projection=ccrs.PlateCarree())
           for label, ds in dict(zip(['control', 'Yatir'], [ctlday, ytrday])).items()]).opts(
    title=dims['FVEG'].label)
this_layout * gf.borders(scale='50m') * gf.coastline(scale='50m') #* gf.ocean(scale='50m')
```

The plots show surface energy and carbon fluxes simulated by WRF for the control run, the Yatir parameterization run, and the difference between the two runs for daylight hours.  The runs constrast more now that the vegetation fraction problem is fixed.

```{python}
#holoviews triggers a matplotlib deprecation warning that prints out a million 
# times per plot; disable warmings for the time being.
import warnings
warnings.filterwarnings('ignore')
```

```{python}
make_var_layout(ds, 'SWDOWN')
```

```{python}
make_var_layout(ds, 'FSA')
```

```{python}
make_var_layout(ds, 'FIRA')
```

```{python}
make_var_layout(ds, 'HFX')
```

```{python}
make_var_layout(ds, 'LH')
```

# WRF domain setup


<img src="./yatir_show_dom.pdf" width=900/>

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
# Yatir parameterization #
<!-- #endregion -->

```{python}
from yatir_land_parameters import format_landparm, format_vegparm
vegparm_str = format_vegparm()
landparm_str = format_landparm()
# print these two strings and paste them into a markdown cell to get a nicely formatted version
```

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
# Sensible Heat #
<!-- #endregion -->

<!-- #region {"ein.tags": "worksheet-0", "slideshow": {"slide_type": "-"}} -->
Yatir sensible heat flux in late August 2015 was 368.8 to 434.4 W m$^{-2}$ ([Brugger et al 2018](https://doi.org/10.1007/s10546-018-0371-5). Table 3).  There was a strong diurnal cycle for both sites (forest and desert).  Note the figure units are K m s$^{-1}$.  Figure from [Banerjee et al, 2018]([www.atmos-chem-phys.net/18/10025/2018/).
            <img src="./Banergee_etal_ACP_2018_fig3.pdf" width=900/>
<!-- #endregion -->

```{python}
t_dim = hv.Dimension('time', label='date', unit='y/m/d')
hfx_dim = hv.Dimension('HFX', label='sensible heat flux', unit='W m-2')
area_dim = hv.Dimension('area', label='parameterization', values=['Yatir cells', 'Desert cells'])
WRFrun_dim = hv.Dimension('WRFrun', label='WRF run', values=['Yatir WRF run', 'Control WRF run'])
```

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
dscombined = xr.concat((HFXytr_d03, HFXctl_d03), dim=pd.Index(['Yatir WRF run', 'Control WRF run'], name='WRFrun'))
hvds = hv.Dataset(dscombined, kdims=['time', 'x', 'y', 'WRFrun'], vdims=['HFX', 'lat', 'lon'])
```

```{python}
hfx_yatir = dscombined.where(dscombined.yatir_mask).mean(dim=['x', 'y'])
hfx_desert = dscombined.where(np.logical_not(dscombined.yatir_mask)).mean(dim=['x', 'y'])
hfx = xr.concat((hfx_yatir, hfx_desert), dim=pd.Index(['Yatir cells', 'Desert cells'], name='area'))
hfxds = hv.Dataset(hfx, [WRFrun_dim, area_dim, t_dim], hfx_dim)
#hfxds.to(hv.Curve, [t_dim], [hfx_dim]).opts(width=600).overlay('area')
```

```{python}
from holoviews.plotting.links import RangeToolLink
hfx_curve = hfxds.to(hv.Curve, [t_dim], [hfx_dim]).overlay('area')
hfx_all = hfx_curve.relabel('HFX').opts(width=600, labelled=['y'], toolbar='above')
hfx_zoomed = hfx_curve.opts(width=600, height=200, default_tools=[], toolbar='disable')
RangeToolLink(source=hfx_all.data[('Yatir WRF run',)][('Yatir cells',)], 
              target=hfx_zoomed.data[('Yatir WRF run',)][('Yatir cells',)], 
              axes=['x', 'y'])
layout = (hfx_all + hfx_zoomed).cols(1)
layout.opts(opts.Layout(shared_axes=False, merge_tools=False))
```

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
# %matplotlib inline
HFX_masked = dscombined.where(dscombined.yatir_mask)
gv.Dataset(HFX_masked, kdims=['WRFrun', 'time', 'lon', 'lat']).to(hv.QuadMesh, ['lon', 'lat'])[:, ::10, :, :]
```

Parse Yatir Forest eddy covariance data

```{python}
df_ytr = pd.read_csv('/Users/tim/work/Data/Yatir_Forest_Data/EFDC_L2_Flx_ILYat_2015_v03_30m.txt',
                    na_values=[-9999])
df_ytr['time'] = pd.to_datetime(df_ytr['TIMESTAMP_START'], format='%Y%m%d%H%M')
df_ytr.replace()
hv_ytr = hv.Table(df_ytr)
cv_obs = hv_ytr.to.curve('time', 'H', [], label='observed')
cv_obs.opts(width=600)
```

Plot HFX for both WRF runs (Control, Yatir) overlaid on a single axes.

```{python ein.hycell=FALSE, ein.tags=worksheet-0, slideshow={'slide_type': '-'}}
hv.extension('bokeh')
hfx_dim_zoomed = hv.Dimension('HFX_zoomed', label='sensible heat flux', unit='W m-2')
def two_panel_energy_flux_plot(ds, obs, t_str=""):
    """make a plot of Yatir surface energy fluxes"""
    gvds = gv.Dataset(ds, kdims=['WRFrun',  'time', 'x', 'y'])
    WRF_run_labels = ds['WRFrun'].values
    line_styles = ['solid', 'dashed']
    cv = [hv.Curve(gvds.reduce(['x', 'y'], 
                               function=np.nanmean).select(WRFrun=this_run), 
                   t_dim, this_v_dim,
                   label=this_run).opts(opts.Curve(line_dash=this_linestyle, line_width=1))
          for this_run, this_linestyle, this_v_dim in zip(WRF_run_labels, 
                                                          line_styles, 
                                                         [hfx_dim, hfx_dim_zoomed])]
    overlay_opts=opts.Overlay(frame_width=690, 
                              legend_position='right', 
                              ylim=(0, 450),
                             title_format=t_str)
    cv_hfx = hv.Overlay(cv).opts(overlay_opts)
    overlay_opts=opts.Overlay(frame_width=690, legend_position='right', ylim=(350, 450))
    cv_hfx_zoomed = hv.Overlay(cv).opts(overlay_opts)
    hvly = hv.Layout([cv_hfx, cv_hfx_zoomed]).cols(1).opts(norm={'axiswise': True})
    return(hvly, cv_hfx, cv_hfx_zoomed)
```

```{python}
all_d03_cells_time_series, cv_hfx, cv_hfx_zoomed = two_panel_energy_flux_plot(dscombined, cv_obs, "all WRF d03 cells")
```

[Brugger et al (2018)](https://doi.org/10.1007/s10546-018-0371-5).  Question from Michael - why are the units W m$^{-1}$ and not W m$^{-2}$?
<img src="./Brugger_etal_2018_table3.jpg" width=900/>
